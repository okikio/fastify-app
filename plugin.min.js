"use strict";function ownKeys(e,r){var t=Object.keys(e);if(Object.getOwnPropertySymbols){var n=Object.getOwnPropertySymbols(e);r&&(n=n.filter(function(r){return Object.getOwnPropertyDescriptor(e,r).enumerable})),t.push.apply(t,n)}return t}function _objectSpread(e){for(var r=1;r<arguments.length;r++){var t=null!=arguments[r]?arguments[r]:{};r%2?ownKeys(t,!0).forEach(function(r){_defineProperty(e,r,t[r])}):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(t)):ownKeys(t).forEach(function(r){Object.defineProperty(e,r,Object.getOwnPropertyDescriptor(t,r))})}return e}function _defineProperty(e,r,t){return r in e?Object.defineProperty(e,r,{value:t,enumerable:!0,configurable:!0,writable:!0}):e[r]=t,e}var _process=process,env=_process.env;"dev"in env||require("dotenv").config();var dev="dev"in env&&"true"==env.dev.toString(),_require=require("fs"),statSync=_require.statSync,createReadStream=_require.createReadStream,_require2=require("stream"),PassThrough=_require2.PassThrough,plugin=require("fastify-plugin"),_require3=require("mime-types"),lookup=_require3.lookup,assets=require("cloudinary").v2,_require4=require("url"),parse=_require4.parse,axios=require("axios"),path=require("path"),glob=require("glob"),send=require("send"),_require5=require("./config".concat(dev?"":".min")),websiteURL=_require5.websiteURL,cloud_name=_require5.cloud_name,imageURLConfig=_require5.imageURLConfig;assets.config({cloud_name:cloud_name,secure:!0});var jsdom=require("jsdom"),JSDOM=jsdom.JSDOM;module.exports._render=plugin(function(e,r,t){var n=r.partial||'[data-barba="container"]',o=r.root||path.join(__dirname,"public");e.cache||e.decorate("cache",{}),e.decorate("path",function(e,r){var t=arguments.length>2&&void 0!==arguments[2]?arguments[2]:".html";return"".concat(r?r+"/":"").concat(e.replace(t,"")).concat(t)}),e.decorateReply("partial",function(r){var t,a=e.path(r,o),i="".concat(a,"__partial__fastify"),c="",s=this;return i in e.cache?s.type("text/html").send(e.cache[i]):createReadStream(a).on("data",function(e){c+=e}).on("error",function(e){s.log.error(e)}).on("close",function(){t=(t=new JSDOM(c).window.document).querySelector(n),c=t.outerHTML,e.cache[i]=c,s.type("text/html").send(c)}),s}),e.decorateReply("html",function(r){var t=e.path(r,o),n="".concat(t,"__fastify"),a="",i=this;return n in e.cache?i.type("text/html").send(e.cache[n]):createReadStream(t).on("data",function(e){a+=e}).on("error",function(e){i.log.error(e)}).on("close",function(){e.cache[n]=a,i.type("text/html").send(a)}),i}),e.decorateReply("render",function(r,t){var n=e.path(r);return t?this.partial(n):this.html(n)}),t()}),module.exports._static=plugin(function(e,r,t){null==r.prefix&&(r.prefix="/");var n="/"==r.prefix[r.prefix.length-1]?r.prefix:r.prefix+"/",o={schema:{hide:void 0===r.schemaHide||r.schemaHide}},a=function(e){var r=arguments.length>1&&void 0!==arguments[1]?arguments[1]:Error;return t(new r(e))},i=r.root,c=r.setHeaders,s={lastModified:r.lastModified,acceptRanges:r.acceptRanges,cacheControl:r.cacheControl,extensions:r.extensions,immutable:r.immutable,dotfiles:r.dotfiles,maxAge:r.maxAge,index:r.index,root:r.root,etag:r.etag};if(null==i)return a('"root" option is required');if("string"!=typeof i)return a('"root" option must be a string');if(!path.isAbsolute(i))return a('"root" option must be an absolute path');try{if(!statSync(i).isDirectory())return a('"root" option must point to a directory');if(null!=c&&"function"!=typeof c)return a("The `setHeaders` option must be a function",TypeError)}catch(r){return"ENOENT"==r.code?e.log.warn('"root" path "'.concat(i,'" must exist')):r}if(e.cache||e.decorate("cache",{}),e.decorate("sendReply",function(t,n,o){var a,i,u,d="static__".concat(o,"__fastify");n.header("cache-control","public, max-age=".concat(r.maxAge)),d in e.cache?n.type(lookup(o)).send(e.cache[d]):((a=send(t.raw,o,s)).on("file",function(e){i=e}),u=new PassThrough({flush:function(e){304==n.res.statusCode&&n.send(""),this.finished=!0,e()}}),Object.assign(u,{getHeader:n.getHeader.bind(n),setHeader:n.header.bind(n),socket:t.raw.socket,finished:!1}),Object.defineProperties(u,{filename:{get:function(){return i}},statusCode:{get:function(){return n.res.statusCode},set:function(e){n.code(e)}}}),u.on("pipe",function(e){n.send(e)}).on("data",function(r){e.cache[d]=Buffer.from(r).toString()}),null!=c&&a.on("headers",c),1==r.redirect&&a.on("directory",function(){var e=parse(t.raw.url);n.redirect(301,e.pathname+"/"+(e.search||""))}),a.on("error",function(e){if(e){if("ENOENT"==e.code)return n.callNotFound();n.send(e)}}),a.pipe(u))}),!1!==r.decorateReply&&e.decorateReply("sendFile",function(r){e.sendReply(this.request,this,r)}),0!=r.serve){if(null!=r.wildcard&&1!=r.wildcard){var u="string"==typeof r.wildcard?r.wildcard:"**/*";return void glob(path.join(s.root,u),{nodir:!0},function(a,i){if(a)return t(a);var c,u,d,l=new Set,p=void 0===r.index?["index.html"]:[].concat(r.index||[]),f=!0,h=!1,g=void 0;try{for(var m,y=i[Symbol.iterator]();!(f=(m=y.next()).done);f=!0){var v=m.value;d=v.replace(s.root.replace(/\\/g,"/"),"").replace(/^\//,""),c=(n+d).replace(/\/\//g,"/"),e.get(c,o,function(r,t){e.sendReply(r,t,"/"+d)}),p.includes(path.posix.basename(c))&&l.add(path.posix.dirname(c))}}catch(a){h=!0,g=a}finally{try{f||null==y.return||y.return()}finally{if(h)throw g}}l.forEach(function(t){u=t+(t.endsWith("/")?"":"/"),d="/"+u.replace(n,""),e.get(u,o,function(r,t){e.sendReply(r,t,d)}),r.redirect&&e.get(u.replace(/\/$/,""),o,function(r,t){e.sendReply(r,t,d.replace(/\/$/,""))})}),t()})}e.get(n+"*",o,function(r,t){e.sendReply(r,t,"/"+r.params["*"])}),r.redirect&&n!=r.prefix&&e.get(r.prefix,o,function(e,r){var t=parse(e.raw.url);r.redirect(301,t.pathname+"/"+(t.search||""))})}t()}),module.exports._assets=plugin(function(e,r,t){var n=r.maxAge;e.get("/assets/*",function(r,t){console.info("LOg ------ ++++ ====    ".concat(r.raw.url));var o=r.raw.url.replace("/assets/",""),a=parse(r.raw.url,!0),i=a.search,c=a.query,s="assets__".concat(a.path,"__fastify");if(t.header("cache-control","public, max-age=".concat(n)),s in e.cache){var u=e.cache[s];u.type?t.type(u.type).send(u.data):t.send(u.data)}else{o=o.replace(i,"");var d,l,p,f,h=lookup(o)||"text/plain",g=/image|video|audio/g.test(h);g?(l=c.h,p=c.w||"auto",f=_objectSpread({},imageURLConfig,{width:p,height:l}),d=assets.url(o,f)):d=assets.url(o).replace("image","raw"),axios.get(d,g?{responseType:"arraybuffer"}:void 0).then(function(r){if(g){var n=Buffer.from(r.data,"base64");return e.cache[s]={type:h,data:n},t.type(h).send(n)}return e.cache[s]=r,t.send(r.data)}).catch(function(r){t.send(r.message),e.log.error(r)})}}),t()}),module.exports._reload=plugin(function(e,r,t){var n=6e4*(r.reloadTime||29);e.reloadCount||e.decorate("reloadCount",0),setInterval(function(){axios.get(websiteURL).then(function(){return console.log("The Heroku server has been reloaded ".concat(++e.reloadCount," times"))}).catch(console.error)},n),t()});