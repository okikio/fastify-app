"use strict";function ownKeys(r,e){var t=Object.keys(r);if(Object.getOwnPropertySymbols){var o=Object.getOwnPropertySymbols(r);e&&(o=o.filter(function(e){return Object.getOwnPropertyDescriptor(r,e).enumerable})),t.push.apply(t,o)}return t}function _objectSpread(r){for(var e=1;e<arguments.length;e++){var t=null!=arguments[e]?arguments[e]:{};e%2?ownKeys(t,!0).forEach(function(e){_defineProperty(r,e,t[e])}):Object.getOwnPropertyDescriptors?Object.defineProperties(r,Object.getOwnPropertyDescriptors(t)):ownKeys(t).forEach(function(e){Object.defineProperty(r,e,Object.getOwnPropertyDescriptor(t,e))})}return r}function _defineProperty(e,r,t){return r in e?Object.defineProperty(e,r,{value:t,enumerable:!0,configurable:!0,writable:!0}):e[r]=t,e}require("core-js/modules/es.symbol"),require("core-js/modules/es.symbol.description"),require("core-js/modules/es.symbol.iterator"),require("core-js/modules/es.array.concat"),require("core-js/modules/es.array.filter"),require("core-js/modules/es.array.for-each"),require("core-js/modules/es.array.includes"),require("core-js/modules/es.array.iterator"),require("core-js/modules/es.array.join"),require("core-js/modules/es.date.to-string"),require("core-js/modules/es.function.bind"),require("core-js/modules/es.object.assign"),require("core-js/modules/es.object.define-properties"),require("core-js/modules/es.object.define-property"),require("core-js/modules/es.object.get-own-property-descriptor"),require("core-js/modules/es.object.get-own-property-descriptors"),require("core-js/modules/es.object.keys"),require("core-js/modules/es.object.to-string"),require("core-js/modules/es.regexp.exec"),require("core-js/modules/es.regexp.to-string"),require("core-js/modules/es.set"),require("core-js/modules/es.string.ends-with"),require("core-js/modules/es.string.includes"),require("core-js/modules/es.string.iterator"),require("core-js/modules/es.string.replace"),require("core-js/modules/es.string.search"),require("core-js/modules/web.dom-collections.for-each"),require("core-js/modules/web.dom-collections.iterator"),require("core-js/modules/web.timers");var _process=process,env=_process.env;"dev"in env||require("dotenv").config();var dev="dev"in env&&"true"==env.dev.toString(),_require=require("fs"),statSync=_require.statSync,createReadStream=_require.createReadStream,_require2=require("stream"),PassThrough=_require2.PassThrough,plugin=require("fastify-plugin"),_require3=require("mime-types"),lookup=_require3.lookup,assets=require("cloudinary").v2,axios=require("axios"),path=require("path"),glob=require("glob"),send=require("send"),url=require("url"),_require4=require("./config".concat(dev?"":".min")),websiteURL=_require4.websiteURL,cloud_name=_require4.cloud_name,imageURLConfig=_require4.imageURLConfig;assets.config({cloud_name:cloud_name,secure:!0});var jsdom=require("jsdom"),JSDOM=jsdom.JSDOM;module.exports._render=plugin(function(a,e,r){var s=e.partial||'[data-barba="container"]',c=e.root||path.join(__dirname,"public");a.cache||a.decorate("cache",{}),a.decorate("path",function(e,r){var t=2<arguments.length&&void 0!==arguments[2]?arguments[2]:".html";return"".concat(r?r+"/":"").concat(e.replace(t,"")).concat(t)}),a.decorateReply("partial",function(e){var r,t=a.path(e,c),o="".concat(t,"__partial__fastify"),n="",i=this;return o in a.cache?i.type("text/html").send(a.cache[o]):createReadStream(t).on("data",function(e){n+=e}).on("error",function(e){i.log.error(e)}).on("close",function(){r=(r=new JSDOM(n).window.document).querySelector(s),n=r.outerHTML,a.cache[o]=n,i.type("text/html").send(n)}),i}),a.decorateReply("html",function(e){var r=a.path(e,c),t="".concat(r,"__fastify"),o="",n=this;return t in a.cache?n.type("text/html").send(a.cache[t]):createReadStream(r).on("data",function(e){o+=e}).on("error",function(e){n.log.error(e)}).on("close",function(){a.cache[t]=o,n.type("text/html").send(o)}),n}),a.decorateReply("render",function(e,r){var t=a.path(e);return r?this.partial(t):this.html(t)}),r()}),module.exports._static=plugin(function(f,m,h){null==m.prefix&&(m.prefix="/");function e(e,r){var t=1<arguments.length&&void 0!==r?r:Error;return h(new t(e))}var g="/"==m.prefix[m.prefix.length-1]?m.prefix:m.prefix+"/",y={schema:{hide:void 0===m.schemaHide||m.schemaHide}},r=m.root,s=m.setHeaders,b={lastModified:m.lastModified,acceptRanges:m.acceptRanges,cacheControl:m.cacheControl,extensions:m.extensions,immutable:m.immutable,dotfiles:m.dotfiles,maxAge:m.maxAge,index:m.index,root:m.root,etag:m.etag};if(null==r)return e('"root" option is required');if("string"!=typeof r)return e('"root" option must be a string');if(!path.isAbsolute(r))return e('"root" option must be an absolute path');try{if(!statSync(r).isDirectory())return e('"root" option must point to a directory');if(null!=s&&"function"!=typeof s)return e("The `setHeaders` option must be a function",TypeError)}catch(e){return"ENOENT"==e.code?f.log.warn('"root" path "'.concat(r,'" must exist')):e}if(f.cache||f.decorate("cache",{}),f.decorate("sendReply",function(r,t,e){var o,n,i,a="static__".concat(e,"__fastify");t.header("cache-control","public, max-age=".concat(m.maxAge)),a in f.cache?t.type(lookup(e)).send(f.cache[a]):((o=send(r.raw,e,b)).on("file",function(e){n=e}),i=new PassThrough({flush:function(e){304==t.res.statusCode&&t.send(""),this.finished=!0,e()}}),Object.assign(i,{getHeader:t.getHeader.bind(t),setHeader:t.header.bind(t),socket:r.raw.socket,finished:!1}),Object.defineProperties(i,{filename:{get:function(){return n}},statusCode:{get:function(){return t.res.statusCode},set:function(e){t.code(e)}}}),i.on("pipe",function(e){t.send(e)}).on("data",function(e){f.cache[a]=Buffer.from(e).toString()}),null!=s&&o.on("headers",s),1==m.redirect&&o.on("directory",function(){var e=url.parse(r.raw.url);t.redirect(301,e.pathname+"/"+(e.search||""))}),o.on("error",function(e){if(e){if("ENOENT"==e.code)return t.callNotFound();t.send(e)}}),o.pipe(i))}),!1!==m.decorateReply&&f.decorateReply("sendFile",function(e){f.sendReply(this.request,this,e)}),0!=m.serve){if(null!=m.wildcard&&1!=m.wildcard){var t="string"==typeof m.wildcard?m.wildcard:"**/*";return void glob(path.join(b.root,t),{nodir:!0},function(e,r){if(e)return h(e);var t,o,n,i=new Set,a=void 0===m.index?["index.html"]:[].concat(m.index||[]),s=!0,c=!1,u=void 0;try{for(var d,l=r[Symbol.iterator]();!(s=(d=l.next()).done);s=!0){var p=d.value;n=p.replace(b.root.replace(/\\/g,"/"),"").replace(/^\//,""),t=(g+n).replace(/\/\//g,"/"),f.get(t,y,function(e,r){f.sendReply(e,r,"/"+n)}),a.includes(path.posix.basename(t))&&i.add(path.posix.dirname(t))}}catch(e){c=!0,u=e}finally{try{s||null==l.return||l.return()}finally{if(c)throw u}}i.forEach(function(e){o=e+(e.endsWith("/")?"":"/"),n="/"+o.replace(g,""),f.get(o,y,function(e,r){f.sendReply(e,r,n)}),m.redirect&&f.get(o.replace(/\/$/,""),y,function(e,r){f.sendReply(e,r,n.replace(/\/$/,""))})}),h()})}f.get(g+"*",y,function(e,r){f.sendReply(e,r,"/"+e.params["*"])}),m.redirect&&g!=m.prefix&&f.get(m.prefix,y,function(e,r){var t=url.parse(e.raw.url);r.redirect(301,t.pathname+"/"+(t.search||""))})}h()}),module.exports._assets=plugin(function(m,e,r){var h=e.maxAge;m.get("/assets/:asset",function(e,t){var r=url.parse(e.raw.url,!0),o=e.params.asset,n=r.search,i=r.query,a=i.h,s=i.w||"auto";o=o.replace(n,"");var c=_objectSpread({},imageURLConfig,{width:s,height:a}),u=assets.url(o,c),d=lookup(u)||"text/plain",l=/image|video/g.test(d),p="assets__".concat(r.path,"__fastify");if(t.header("cache-control","public, max-age=".concat(h)),p in m.cache){var f=m.cache[p];f.type?t.type(f.type).send(f.data):t.send(f.data)}else/text|application/g.test(d)&&(u=u.replace("image","raw")),axios.get(u,l?{responseType:"arraybuffer"}:void 0).then(function(e){if(l){var r=Buffer.from(e.data,"base64");return m.cache[p]={type:d,data:r},t.type(d).send(r)}return m.cache[p]={data:e.data},t.send(e.data)}).catch(function(e){t.send(e.message),m.log.error(e)})}),r()}),module.exports._reload=plugin(function(e,r,t){var o=6e4*(r.reloadTime||29);e.reloadCount||e.decorate("reloadCount",0),setInterval(function(){axios.get(websiteURL).then(function(){return console.log("The Heroku server has been reloaded ".concat(++e.reloadCount," times"))}).catch(console.error)},o),t()});