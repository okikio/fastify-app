"use strict";"dev"in process.env&&require("dotenv").config();var _require=require("fs"),statSync=_require.statSync,createReadStream=_require.createReadStream,_require2=require("stream"),PassThrough=_require2.PassThrough,plugin=require("fastify-plugin"),_require3=require("mime-types"),lookup=_require3.lookup,assets=require("cloudinary").v2,axios=require("axios"),path=require("path"),glob=require("glob"),send=require("send"),url=require("url"),_require4=require("./config.min"),cloud_name=_require4.cloud_name;assets.config({cloud_name:cloud_name,secure:!0});var jsdom=require("jsdom"),JSDOM=jsdom.JSDOM;module.exports._render=plugin(function(i,e,t){var c=e.partial||'[data-barba="container"]',s=e.root||path.join(__dirname,"public");i.cache||i.decorate("cache",{}),i.decorate("path",function(e,t){var r=2<arguments.length&&void 0!==arguments[2]?arguments[2]:".html";return"".concat(t?t+"/":"").concat(e.replace(r,"")).concat(r)}),i.decorateReply("partial",function(e){var t,r=i.path(e,s),a="".concat(r,"__partial__fastify"),n="",o=this;return a in i.cache?o.type("text/html").send(i.cache[a]):createReadStream(r).on("data",function(e){n+=e}).on("error",function(e){o.log.error(e)}).on("close",function(){t=(t=new JSDOM(n).window.document).querySelector(c),n=t.outerHTML,i.cache[a]=n,o.type("text/html").send(n)}),o}),i.decorateReply("html",function(e){var t=i.path(e,s),r="".concat(t,"__fastify"),a="",n=this;return r in i.cache?n.type("text/html").send(i.cache[r]):createReadStream(t).on("data",function(e){a+=e}).on("error",function(e){n.log.error(e)}).on("close",function(){i.cache[r]=a,n.type("text/html").send(a)}),n}),i.decorateReply("render",function(e,t){var r=i.path(e);return t?this.partial(r):this.html(r)}),t()}),module.exports._static=plugin(function(f,h,m){null==h.prefix&&(h.prefix="/");var g="/"==h.prefix[h.prefix.length-1]?h.prefix:h.prefix+"/",y={schema:{hide:void 0===h.schemaHide||h.schemaHide}},e=function(e){var t=1<arguments.length&&void 0!==arguments[1]?arguments[1]:Error;return m(new t(e))},t=h.root,c=h.setHeaders,x={lastModified:h.lastModified,acceptRanges:h.acceptRanges,cacheControl:h.cacheControl,extensions:h.extensions,immutable:h.immutable,dotfiles:h.dotfiles,maxAge:h.maxAge,index:h.index,root:h.root,etag:h.etag};if(null==t)return e('"root" option is required');if("string"!=typeof t)return e('"root" option must be a string');if(!path.isAbsolute(t))return e('"root" option must be an absolute path');try{if(!statSync(t).isDirectory())return e('"root" option must point to a directory');if(null!=c&&"function"!=typeof c)return e("The `setHeaders` option must be a function",TypeError)}catch(e){return"ENOENT"==e.code?f.log.warn('"root" path "'.concat(t,'" must exist')):e}if(f.cache||f.decorate("cache",{}),f.decorate("sendReply",function(t,r,e){var a,n,o,i="static__".concat(e,"__fastify");r.header("cache-control","public, max-age=".concat(h.maxAge)),i in f.cache?r.type(lookup(e)).send(f.cache[i]):((a=send(t.raw,e,x)).on("file",function(e){n=e}),o=new PassThrough({flush:function(e){304==r.res.statusCode&&r.send(""),this.finished=!0,e()}}),Object.assign(o,{getHeader:r.getHeader.bind(r),setHeader:r.header.bind(r),socket:t.raw.socket,finished:!1}),Object.defineProperties(o,{filename:{get:function(){return n}},statusCode:{get:function(){return r.res.statusCode},set:function(e){r.code(e)}}}),o.on("pipe",function(e){r.send(e)}).on("data",function(e){f.cache[i]=Buffer.from(e).toString()}),null!=c&&a.on("headers",c),1==h.redirect&&a.on("directory",function(){var e=url.parse(t.raw.url);r.redirect(301,e.pathname+"/"+(e.search||""))}),a.on("error",function(e){if(e){if("ENOENT"==e.code)return r.callNotFound();r.send(e)}}),a.pipe(o))}),!1!==h.decorateReply&&f.decorateReply("sendFile",function(e){f.sendReply(this.request,this,e)}),0!=h.serve){if(null!=h.wildcard&&1!=h.wildcard){var r="string"==typeof h.wildcard?h.wildcard:"**/*";return void glob(path.join(x.root,r),{nodir:!0},function(e,t){if(e)return m(e);var r,a,n,o=new Set,i=void 0===h.index?["index.html"]:[].concat(h.index||[]),c=!0,s=!1,u=void 0;try{for(var d,l=t[Symbol.iterator]();!(c=(d=l.next()).done);c=!0){var p=d.value;n=p.replace(x.root.replace(/\\/g,"/"),"").replace(/^\//,""),r=(g+n).replace(/\/\//g,"/"),f.get(r,y,function(e,t){f.sendReply(e,t,"/"+n)}),i.includes(path.posix.basename(r))&&o.add(path.posix.dirname(r))}}catch(e){s=!0,u=e}finally{try{c||null==l.return||l.return()}finally{if(s)throw u}}o.forEach(function(e){a=e+(e.endsWith("/")?"":"/"),n="/"+a.replace(g,""),f.get(a,y,function(e,t){f.sendReply(e,t,n)}),h.redirect&&f.get(a.replace(/\/$/,""),y,function(e,t){f.sendReply(e,t,n.replace(/\/$/,""))})}),m()})}f.get(g+"*",y,function(e,t){f.sendReply(e,t,"/"+e.params["*"])}),h.redirect&&g!=h.prefix&&f.get(h.prefix,y,function(e,t){var r=url.parse(e.raw.url);t.redirect(301,r.pathname+"/"+(r.search||""))})}m()}),module.exports._assets=plugin(function(s,e,t){var u=e.maxAge;s.get("/assets/:asset",function(e,r){var t=e.params.asset,a=assets.url(t,{quality:30,transformation:[{aspect_ratio:"4:3",crop:"fill"},{width:"auto",dpr:"auto",crop:"scale"}]}),n=lookup(a)||"text/plain",o=/image|video/g.test(n),i="assets__".concat(t,"__fastify");if(r.header("cache-control","public, max-age=".concat(u)),i in s.cache){var c=s.cache[i];c.type?r.type(c.type).send(c.data):r.send(c.data)}else/text|application/g.test(n)&&(a=a.replace("image","raw")),axios.get(a,o?{responseType:"arraybuffer"}:void 0).then(function(e){if(o){var t=Buffer.from(e.data,"base64");return s.cache[i]={type:n,data:t},r.type(n).send(t)}return s.cache[i]={data:e.data},r.send(e.data)}).catch(function(e){r.send(e.message),s.log.error(e)})}),t()});