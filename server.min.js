"use strict";require("dotenv").config();var compress=require("fastify-compress"),_static=require("fastify-static"),noIcon=require("fastify-no-icon"),helmet=require("fastify-helmet"),assets=require("cloudinary").v2,cors=require("fastify-cors"),fastify=require("fastify"),axios=require("axios"),path=require("path"),_require=require("./config.min"),routes=_require.routes,_require2=require("./plugin.min"),render=_require2.render,PORT=process.env.PORT||3e3,root=path.join(__dirname,"public"),dev="true"==process.env.dev,maxAge=1e3*(dev?0:1)*60*60*24*7,app=fastify({logger:dev&&{prettyPrint:{translateTime:"hh:MM:ss TT"}},ignoreTrailingSlash:!0,caseSensitive:!1});void 0===process.env.CLOUDINARY_URL&&(console.warn("!! Cloudinary config is undefined !!"),console.warn("export CLOUDINARY_URL or set dotenv file")),app.register(compress).register(helmet).register(noIcon).register(render).register(cors,{cacheControl:!0,maxAge:maxAge}).register(_static,{cacheControl:!0,maxAge:maxAge,root:root}),app.get("/assets/:asset",function(e,r){var t=e.params.asset,a=assets.url(t,{quality:30,transformation:[{aspect_ratio:"4:3",crop:"fill"},{width:"auto",dpr:"auto",crop:"scale"}]}),i=a.lastIndexOf("."),s={html:"text/html",txt:"text/plain",css:"text/css",gif:"image/gif",jpg:"image/jpeg",png:"image/png",svg:"image/svg+xml",js:"application/javascript"}[a.slice(i+1)]||"text/plain",o=/image/g.test(s),n="assets__".concat(t,"__fastify");if(r.header("cache-control","public, max-age=".concat(maxAge)),n in app.cache){var c=app.cache[n];c.type?r.type(c.type).send(c.data):r.send(c.data)}else/text|application/g.test(s)&&(a=a.replace("image","raw")),axios.get(a,o?{responseType:"arraybuffer"}:void 0).then(function(e){if(o){var t=Buffer.from(e.data,"base64");return app.cache[n]={type:e.headers["content-type"],data:t},r.type(e.headers["content-type"]).send(t)}return app.cache[n]={data:e.data},r.send(e.data)}).catch(function(e){r.send(e.message),app.log.error(e)})});var _loop=function(r){app.get(r,function(e,t){t.header("cache-control","public, max-age=".concat(maxAge)),t.render(routes[r],e.headers["x-barba"])})};for(var i in routes)_loop(i);app.setNotFoundHandler(function(e,t){t.code(404).type("text/plain").send("A custom not found")}),app.listen(PORT,function(e){e&&app.log.error(e),app.log.info("Server listening on port",PORT)});