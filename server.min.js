"use strict";function _interopDefault(e){return e&&"object"==typeof e&&"default"in e?e.default:e}var e=_interopDefault(require("dotenv")),t=_interopDefault(require("fastify-compress")),r=_interopDefault(require("fastify-no-icon")),n=_interopDefault(require("fastify-helmet")),o=_interopDefault(require("fastify-cors")),a=_interopDefault(require("fastify")),i=_interopDefault(require("morgan")),c=_interopDefault(require("path")),s=_interopDefault(require("fs")),u=_interopDefault(require("stream")),l=_interopDefault(require("fastify-plugin")),f=_interopDefault(require("mime-types")),p=_interopDefault(require("cloudinary")),d=_interopDefault(require("url")),h=_interopDefault(require("axios")),g=_interopDefault(require("glob")),y=_interopDefault(require("send")),m=_interopDefault(require("fast-html-parser")),v="https://app-fast.herokuapp.com/",_="okikio-assets",b={flags:"progressive:steep",fetch_format:"auto",client_hints:!0,crop:"scale",quality:30,dpr:"auto"},x={"/":"index","/about":"about","/projects":"project"};function _defineProperty(e,t,r){return t in e?Object.defineProperty(e,t,{value:r,enumerable:!0,configurable:!0,writable:!0}):e[t]=r,e}function ownKeys(e,t){var r=Object.keys(e);if(Object.getOwnPropertySymbols){var n=Object.getOwnPropertySymbols(e);t&&(n=n.filter((function(t){return Object.getOwnPropertyDescriptor(e,t).enumerable}))),r.push.apply(r,n)}return r}function _toConsumableArray(e){return function _arrayWithoutHoles(e){if(Array.isArray(e)){for(var t=0,r=new Array(e.length);t<e.length;t++)r[t]=e[t];return r}}(e)||function _iterableToArray(e){if(Symbol.iterator in Object(e)||"[object Arguments]"===Object.prototype.toString.call(e))return Array.from(e)}(e)||function _nonIterableSpread(){throw new TypeError("Invalid attempt to spread non-iterable instance")}()}var w=s.statSync,q=s.createReadStream,D=u.PassThrough,O=f.lookup,j=p.v2,T=d.parse,P=v,S=_,A=b;j.config({cloud_name:S,secure:!0});var C={_render:l((function(e,t,r){var n=t.partial||'[data-barba="container"]',o=t.root||c.join(__dirname,"public");e.cache||e.decorate("cache",{}),e.decorate("path",(function(e,t){var r=arguments.length>2&&void 0!==arguments[2]?arguments[2]:".html";return"".concat(t?t+"/":"").concat(e.replace(r,"")).concat(r)})),e.decorateReply("partial",(function(t){var r,a=e.path(t,o),i="".concat(a,"__partial__fastify"),c="",s=this;return i in e.cache?s.type("text/html").send(e.cache[i]):q(a).on("data",(function(e){c+=e})).on("error",(function(e){s.log.error(e)})).on("close",(function(){r=_toConsumableArray(m.parse(c).querySelectorAll(n)),e.cache[i]=r.filter((function(e){return e.outerHTML})).join(""),s.type("text/html").send(e.cache[i])})),s})),e.decorateReply("html",(function(t){var r=e.path(t,o),n="".concat(r,"__fastify"),a="",i=this;return n in e.cache?i.type("text/html").send(e.cache[n]):q(r).on("data",(function(e){a+=e})).on("error",(function(e){i.log.error(e)})).on("close",(function(){e.cache[n]=a,i.type("text/html").send(a)})),i})),e.decorateReply("render",(function(t,r){var n=e.path(t);return r?this.partial(n):this.html(n)})),r()})),_static:l((function(e,t,r){void 0===t.prefix&&(t.prefix="/");var n="/"===t.prefix[t.prefix.length-1]?t.prefix:t.prefix+"/",o={schema:{hide:void 0===t.schemaHide||t.schemaHide}},a=function _err(e){var t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:Error;return r(new t(e))},i=t.root,s=t.setHeaders,u={lastModified:t.lastModified,acceptRanges:t.acceptRanges,cacheControl:t.cacheControl,extensions:t.extensions,immutable:t.immutable,dotfiles:t.dotfiles,maxAge:t.maxAge,index:t.index,root:t.root,etag:t.etag};if(void 0===i)return a('"root" option is required');if("string"!=typeof i)return a('"root" option must be a string');if(!c.isAbsolute(i))return a('"root" option must be an absolute path');try{if(!w(i).isDirectory())return a('"root" option must point to a directory');if(void 0!==s&&"function"!=typeof s)return a("The `setHeaders` option must be a function",TypeError)}catch(t){return"ENOENT"===t.code?e.log.warn('"root" path "'.concat(i,'" must exist')):t}if(e.cache||e.decorate("cache",{}),e.decorate("sendReply",(function(r,n,o){var a,i,c,l="static__".concat(o,"__fastify");n.header("cache-control","public, max-age=".concat(t.maxAge)),l in e.cache?n.type(O(o)).send(e.cache[l]):((a=y(r.raw,o,u)).on("file",(function(e){i=e})),c=new D({flush:function flush(e){304===n.res.statusCode&&n.send(""),this.finished=!0,e()}}),Object.assign(c,{getHeader:n.getHeader.bind(n),setHeader:n.header.bind(n),socket:r.raw.socket,finished:!1}),Object.defineProperties(c,{filename:{get:function get(){return i}},statusCode:{get:function get(){return n.res.statusCode},set:function set(e){n.code(e)}}}),c.on("pipe",(function(e){n.send(e)})).on("data",(function(t){e.cache[l]=Buffer.from(t).toString()})),void 0!==s&&a.on("headers",s),!0===t.redirect&&a.on("directory",(function(){var e=T(r.raw.url);n.redirect(301,e.pathname+"/"+(e.search||""))})),a.on("error",(function(e){if(e){if("ENOENT"===e.code)return n.callNotFound();n.send(e)}})),a.pipe(c))})),!1!==t.decorateReply&&e.decorateReply("sendFile",(function(t){e.sendReply(this.request,this,t)})),!1!==t.serve){if(void 0!==t.wildcard&&!0!==t.wildcard){var l="string"==typeof t.wildcard?t.wildcard:"**/*";return void g(c.join(u.root,l),{nodir:!0},(function(a,i){if(a)return r(a);var s,l,f,p=new Set,d=void 0===t.index?["index.html"]:[].concat(t.index||[]),h=!0,g=!1,y=void 0;try{for(var m,v=i[Symbol.iterator]();!(h=(m=v.next()).done);h=!0){var _=m.value;f=_.replace(u.root.replace(/\\/g,"/"),"").replace(/^\//,""),s=(n+f).replace(/\/\//g,"/"),e.get(s,o,(function(t,r){e.sendReply(t,r,"/"+f)})),d.includes(c.posix.basename(s))&&p.add(c.posix.dirname(s))}}catch(a){g=!0,y=a}finally{try{h||null==v.return||v.return()}finally{if(g)throw y}}p.forEach((function(r){l=r+(r.endsWith("/")?"":"/"),f="/"+l.replace(n,""),e.get(l,o,(function(t,r){e.sendReply(t,r,f)})),t.redirect&&e.get(l.replace(/\/$/,""),o,(function(t,r){e.sendReply(t,r,f.replace(/\/$/,""))}))})),r()}))}e.get(n+"*",o,(function(t,r){e.sendReply(t,r,"/"+t.params["*"])})),t.redirect&&n!==t.prefix&&e.get(t.prefix,o,(function(e,t){var r=T(e.raw.url);t.redirect(301,r.pathname+"/"+(r.search||""))}))}r()})),_assets:l((function(e,t,r){var n=t.maxAge;e.get("/assets/*",(function(t,r){var o=t.raw.url.replace("/assets/",""),a=T(t.raw.url,!0),i=a.search,c=a.query,s="assets__".concat(a.path,"__fastify");if(r.header("cache-control","public, max-age=".concat(n)),s in e.cache){var u=e.cache[s];u.type?r.type(u.type).send(u.data):r.send(u.data)}else{o=o.replace(i,"");var l,f,p,d,g,y,m,v=O(o)||"text/plain",_=/image|video|audio/g.test(v);_?(f=c.get("h"),p=c.get("w")||"auto",y=c.get("crop")||A.crop,g=c.get("effect")||A.effect,d=c.get("quality")||A.quality,m=function _objectSpread2(e){for(var t=1;t<arguments.length;t++){var r=null!=arguments[t]?arguments[t]:{};t%2?ownKeys(r,!0).forEach((function(t){_defineProperty(e,t,r[t])})):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(r)):ownKeys(r).forEach((function(t){Object.defineProperty(e,t,Object.getOwnPropertyDescriptor(r,t))}))}return e}({},A,{width:p,height:f,quality:d,crop:y,effect:g}),l=j.url(o,m)):l=j.url(o).replace("image","raw"),h.get(l,_?{responseType:"arraybuffer"}:void 0).then((function(t){if(_){var n=Buffer.from(t.data,"base64");return e.cache[s]={type:v,data:n},r.type(v).send(n)}return e.cache[s]=t,r.send(t.data)})).catch((function(t){r.send(t.message),e.log.error(t)}))}})),r()})),_reload:l((function(e,t,r){var n=6e4*(t.reloadTime||29);e.reloadCount||e.decorate("reloadCount",0),setInterval((function(){h.get(P).then((function(){return console.log("The Heroku server has been reloaded ".concat(++e.reloadCount," times"))})).catch(console.error)}),n),r()}))},R=process.env;"dev"in R||e.config();var E="dev"in R&&"true"===R.dev.toString(),H="heroku"in R&&"true"===R.heroku.toString(),k=x,N=C._render,I=C._static,M=C._assets,F=H?"0.0.0.0":"localhost",K=c.join(__dirname,"public"),B=function normalizePort(e){var t=parseInt(e,10);return isNaN(t)?e:t>=0&&t}(process.env.PORT||3e3),W=1e3*(E?0:1)*60*60*24*7,$=a({logger:E&&{prettyPrint:{translateTime:"hh:MM:ss TT",ignore:"pid,hostname,reqId"}},ignoreTrailingSlash:!0,caseSensitive:!1});$.use(i("dev")).register(t).register(n).register(r).register(N,{partial:"#swup"}).register(M,{maxAge:W}).register(o,{methods:["GET","PUT","POST"],cacheControl:!0,maxAge:W,preflightContinue:!0,preflight:!0}).register(I,{cacheControl:!0,maxAge:W,root:K});var z=function _loop(e){$.get(e,(function(t,r){r.header("cache-control","public, max-age=".concat(W)),r.render(k[e],t.headers["x-partial"])}))};for(var G in k)z(G);$.setNotFoundHandler((function(e,t){t.code(404).type(e.headers["content-type"]||"text/plain").render("404",e.headers["x-partial"])})),$.setErrorHandler((function(e,t,r){var n=e.statusCode>=400?e.statusCode:500;t.log.warn(e),r.code(n).type(t.headers["content-type"]||"text/plain").send(n>=500?"Internal server error":e.message)})),$.listen(B,F,(function(e){e&&$.log.error(e),$.log.info("Server listening on port",B)}));module.exports={};