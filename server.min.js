"use strict";require("dotenv").config();var compress=require("fastify-compress"),_static=require("fastify-static"),noIcon=require("fastify-no-icon"),helmet=require("fastify-helmet"),assets=require("cloudinary").v2,cors=require("fastify-cors"),fastify=require("fastify"),axios=require("axios"),path=require("path"),_require=require("./config.min"),routes=_require.routes,_require2=require("./plugin.min"),render=_require2.render,PORT=process.env.PORT||3e3,root=path.join(__dirname,"public"),dev=process.env.dev,maxAge=1e3*(dev?0:1)*60*60*24*7,app=fastify({logger:dev&&{prettyPrint:{translateTime:"hh:MM:ss TT"}},ignoreTrailingSlash:!0,caseSensitive:!1});void 0===process.env.CLOUDINARY_URL&&(console.warn("!! Cloudinary config is undefined !!"),console.warn("export CLOUDINARY_URL or set dotenv file")),app.register(compress).register(helmet).register(noIcon).register(render).register(cors,{cacheControl:!0,maxAge:maxAge}).register(_static,{cacheControl:!0,maxAge:maxAge,root:root}),app.get("/assets/:asset",function(e,t){var r=e.params.asset,a=assets.url(r),s=a.lastIndexOf("."),i={html:"text/html",txt:"text/plain",css:"text/css",gif:"image/gif",jpg:"image/jpeg",png:"image/png",svg:"image/svg+xml",js:"application/javascript"}[a.slice(s+1)]||"text/plain",n=/image/g.test(i),o="assets__".concat(r,"__fastify");if(t.header("cache-control","public, max-age=".concat(maxAge)),o in app.cache){var c=app.cache[o];c.type?t.type(c.type).send(c.data):t.send(c.data)}else/text|application/g.test(i)&&(a=a.replace("image","raw")),axios.get(a,n?{responseType:"arraybuffer"}:void 0).then(function(e){if(n){var r=Buffer.from(e.data,"base64");return app.cache[o]={type:e.headers["content-type"],data:r},t.type(e.headers["content-type"]).send(r)}return app.cache[o]={data:e.data},t.send(e.data)}).catch(function(e){t.send(e.message),app.log.error(e)})});var _loop=function(t){app.get(t,function(e,r){r.header("cache-control","public, max-age=".concat(maxAge)),r.render(routes[t],e.headers["x-barba"])})};for(var i in routes)_loop(i);app.setNotFoundHandler(function(e,r){r.code(404).type("text/plain").send("A custom not found")}),app.listen(PORT,function(e){e&&app.log.error(e),app.log.info("Server listening on port",PORT)});