"use strict";function e(e){return e&&"object"==typeof e&&"default"in e?e.default:e}var t=e(require("dotenv")),r=e(require("fastify-compress")),n=e(require("fastify-no-icon")),a=e(require("fastify-helmet")),o=e(require("fastify-cors")),i=e(require("fastify")),c=e(require("morgan")),s=e(require("path")),u=e(require("fs")),l=e(require("stream")),d=e(require("fastify-plugin")),f=e(require("mime-types")),p=e(require("cloudinary")),h=e(require("url")),g=e(require("axios")),y=e(require("glob")),m=e(require("send")),v=e(require("fast-html-parser")),b="https://app-fast.herokuapp.com/",x="okikio-assets",_={fetch_format:"auto",client_hints:!0,crop:"scale",quality:30,dpr:"auto"},w={"/":"index","/about":"about"};function q(e,t,r){return t in e?Object.defineProperty(e,t,{value:r,enumerable:!0,configurable:!0,writable:!0}):e[t]=r,e}function O(e,t){var r=Object.keys(e);if(Object.getOwnPropertySymbols){var n=Object.getOwnPropertySymbols(e);t&&(n=n.filter(function(t){return Object.getOwnPropertyDescriptor(e,t).enumerable})),r.push.apply(r,n)}return r}var T=u.statSync,j=u.createReadStream,P=l.PassThrough,R=f.lookup,S=p.v2,C=h.parse,E=b,H=x,k=_;S.config({cloud_name:H,secure:!0});var A={_render:d(function(e,t,r){var n=t.partial||'[data-barba="container"]',a=t.root||s.join(__dirname,"public");e.cache||e.decorate("cache",{}),e.decorate("path",function(e,t){var r=arguments.length>2&&void 0!==arguments[2]?arguments[2]:".html";return"".concat(t?t+"/":"").concat(e.replace(r,"")).concat(r)}),e.decorateReply("partial",function(t){var r,o=e.path(t,a),i="".concat(o,"__partial__fastify"),c="",s=this;return i in e.cache?s.type("text/html").send(e.cache[i]):j(o).on("data",function(e){c+=e}).on("error",function(e){s.log.error(e)}).on("close",function(){r=v.parse(c).querySelector(n),e.cache[i]=r.outerHTML,s.type("text/html").send(e.cache[i])}),s}),e.decorateReply("html",function(t){var r=e.path(t,a),n="".concat(r,"__fastify"),o="",i=this;return n in e.cache?i.type("text/html").send(e.cache[n]):j(r).on("data",function(e){o+=e}).on("error",function(e){i.log.error(e)}).on("close",function(){e.cache[n]=o,i.type("text/html").send(o)}),i}),e.decorateReply("render",function(t,r){var n=e.path(t);return r?this.partial(n):this.html(n)}),r()}),_static:d(function(e,t,r){null==t.prefix&&(t.prefix="/");var n="/"==t.prefix[t.prefix.length-1]?t.prefix:t.prefix+"/",a={schema:{hide:void 0===t.schemaHide||t.schemaHide}},o=function(e){var t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:Error;return r(new t(e))},i=t.root,c=t.setHeaders,u={lastModified:t.lastModified,acceptRanges:t.acceptRanges,cacheControl:t.cacheControl,extensions:t.extensions,immutable:t.immutable,dotfiles:t.dotfiles,maxAge:t.maxAge,index:t.index,root:t.root,etag:t.etag};if(null==i)return o('"root" option is required');if("string"!=typeof i)return o('"root" option must be a string');if(!s.isAbsolute(i))return o('"root" option must be an absolute path');try{if(!T(i).isDirectory())return o('"root" option must point to a directory');if(null!=c&&"function"!=typeof c)return o("The `setHeaders` option must be a function",TypeError)}catch(t){return"ENOENT"==t.code?e.log.warn('"root" path "'.concat(i,'" must exist')):t}if(e.cache||e.decorate("cache",{}),e.decorate("sendReply",function(r,n,a){var o,i,s,l="static__".concat(a,"__fastify");n.header("cache-control","public, max-age=".concat(t.maxAge)),l in e.cache?n.type(R(a)).send(e.cache[l]):((o=m(r.raw,a,u)).on("file",function(e){i=e}),s=new P({flush:function(e){304==n.res.statusCode&&n.send(""),this.finished=!0,e()}}),Object.assign(s,{getHeader:n.getHeader.bind(n),setHeader:n.header.bind(n),socket:r.raw.socket,finished:!1}),Object.defineProperties(s,{filename:{get:function(){return i}},statusCode:{get:function(){return n.res.statusCode},set:function(e){n.code(e)}}}),s.on("pipe",function(e){n.send(e)}).on("data",function(t){e.cache[l]=Buffer.from(t).toString()}),null!=c&&o.on("headers",c),1==t.redirect&&o.on("directory",function(){var e=C(r.raw.url);n.redirect(301,e.pathname+"/"+(e.search||""))}),o.on("error",function(e){if(e){if("ENOENT"==e.code)return n.callNotFound();n.send(e)}}),o.pipe(s))}),!1!==t.decorateReply&&e.decorateReply("sendFile",function(t){e.sendReply(this.request,this,t)}),0!=t.serve){if(null!=t.wildcard&&1!=t.wildcard){var l="string"==typeof t.wildcard?t.wildcard:"**/*";return void y(s.join(u.root,l),{nodir:!0},function(o,i){if(o)return r(o);var c,l,d,f=new Set,p=void 0===t.index?["index.html"]:[].concat(t.index||[]),h=!0,g=!1,y=void 0;try{for(var m,v=i[Symbol.iterator]();!(h=(m=v.next()).done);h=!0){var b=m.value;d=b.replace(u.root.replace(/\\/g,"/"),"").replace(/^\//,""),c=(n+d).replace(/\/\//g,"/"),e.get(c,a,function(t,r){e.sendReply(t,r,"/"+d)}),p.includes(s.posix.basename(c))&&f.add(s.posix.dirname(c))}}catch(o){g=!0,y=o}finally{try{h||null==v.return||v.return()}finally{if(g)throw y}}f.forEach(function(r){l=r+(r.endsWith("/")?"":"/"),d="/"+l.replace(n,""),e.get(l,a,function(t,r){e.sendReply(t,r,d)}),t.redirect&&e.get(l.replace(/\/$/,""),a,function(t,r){e.sendReply(t,r,d.replace(/\/$/,""))})}),r()})}e.get(n+"*",a,function(t,r){e.sendReply(t,r,"/"+t.params["*"])}),t.redirect&&n!=t.prefix&&e.get(t.prefix,a,function(e,t){var r=C(e.raw.url);t.redirect(301,r.pathname+"/"+(r.search||""))})}r()}),_assets:d(function(e,t,r){var n=t.maxAge;e.get("/assets/*",function(t,r){var a=t.raw.url.replace("/assets/",""),o=C(t.raw.url,!0),i=o.search,c=o.query,s="assets__".concat(o.path,"__fastify");if(r.header("cache-control","public, max-age=".concat(n)),s in e.cache){var u=e.cache[s];u.type?r.type(u.type).send(u.data):r.send(u.data)}else{a=a.replace(i,"");var l,d,f,p,h=R(a)||"text/plain",y=/image|video|audio/g.test(h);y?(d=c.h,f=c.w||"auto",p=function(e){for(var t=1;t<arguments.length;t++){var r=null!=arguments[t]?arguments[t]:{};t%2?O(r,!0).forEach(function(t){q(e,t,r[t])}):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(r)):O(r).forEach(function(t){Object.defineProperty(e,t,Object.getOwnPropertyDescriptor(r,t))})}return e}({},k,{width:f,height:d}),l=S.url(a,p)):l=S.url(a).replace("image","raw"),g.get(l,y?{responseType:"arraybuffer"}:void 0).then(function(t){if(y){var n=Buffer.from(t.data,"base64");return e.cache[s]={type:h,data:n},r.type(h).send(n)}return e.cache[s]=t,r.send(t.data)}).catch(function(t){r.send(t.message),e.log.error(t)})}}),r()}),_reload:d(function(e,t,r){var n=6e4*(t.reloadTime||29);e.reloadCount||e.decorate("reloadCount",0),setInterval(function(){g.get(E).then(function(){return console.log("The Heroku server has been reloaded ".concat(++e.reloadCount," times"))}).catch(console.error)},n),r()})},N=process.env;"dev"in N||t.config();var D,M,I="dev"in N&&"true"==N.dev.toString(),F="heroku"in N&&"true"==N.heroku.toString(),B=w,$=A._render,G=A._static,L=A._assets,U=F?"0.0.0.0":"localhost",W=s.join(__dirname,"public"),z=(D=process.env.PORT||3e3,M=parseInt(D,10),isNaN(M)?D:M>=0&&M),J=1e3*(I?0:1)*60*60*24*7,K=i({logger:I&&{prettyPrint:{translateTime:"hh:MM:ss TT",ignore:"pid,hostname,reqId"}},ignoreTrailingSlash:!0,caseSensitive:!1});K.use(c("dev")).register(r).register(a).register(n).register($,{partial:"#swup"}).register(L,{maxAge:J}).register(o,{methods:["GET","PUT","POST"],cacheControl:!0,maxAge:J,preflightContinue:!0,preflight:!0}).register(G,{cacheControl:!0,maxAge:J,root:W});var Q=function(e){K.get(e,function(t,r){r.header("cache-control","public, max-age=".concat(J)),r.render(B[e],t.headers["x-partial"])})};for(var V in B)Q(V);K.setNotFoundHandler(function(e,t){t.code(404).type(e.headers["content-type"]||"text/plain").render("404",e.headers["x-partial"])}),K.setErrorHandler(function(e,t,r){var n=e.statusCode>=400?e.statusCode:500;t.log.warn(e),r.code(n).type(t.headers["content-type"]||"text/plain").send(n>=500?"Internal server error":e.message)}),K.listen(z,U,function(e){e&&K.log.error(e),K.log.info("Server listening on port",z)});module.exports={};