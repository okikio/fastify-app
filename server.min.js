"use strict";require("dotenv").config();var compress=require("fastify-compress"),_static=require("fastify-static"),noIcon=require("fastify-no-icon"),helmet=require("fastify-helmet"),assets=require("cloudinary").v2,fastify=require("fastify"),axios=require("axios"),path=require("path"),_require=require("./config"),routes=_require.routes,_require2=require("./plugin"),render=_require2.render,PORT=process.env.PORT||3e3,root=path.join(__dirname,"public"),dev="developement"==process.env.NODE_ENV,app=fastify({logger:dev&&{prettyPrint:{translateTime:"hh:MM:ss TT"}},ignoreTrailingSlash:!0,caseSensitive:!1});void 0===process.env.CLOUDINARY_URL&&(console.warn("!! Cloudinary config is undefined !!"),console.warn("export CLOUDINARY_URL or set dotenv file")),app.register(compress).register(helmet).register(noIcon).register(render).register(_static,{maxAge:1e3*(dev?0:1)*60*60*24*7,cacheControl:!0,root:root}).register(_static,{maxAge:1e3*(dev?0:1)*60*60*24*7,cacheControl:!0,root:path.join(__dirname,"config.min.js")}),app.get("/assets/:asset",function(e,r){var t=e.params.asset,a=assets.url(t),s=a.lastIndexOf("."),i={html:"text/html",txt:"text/plain",css:"text/css",gif:"image/gif",jpg:"image/jpeg",png:"image/png",svg:"image/svg+xml",js:"application/javascript"}[a.slice(s+1)]||"text/plain",n=/image/g.test(i),o="assets__".concat(t,"__fastify");if(o in app.cache){var p=app.cache[o];p.type?r.type(p.type).send(p.data):r.send(p.data)}else/text|application/g.test(i)&&(a=a.replace("image","raw")),axios.get(a,n?{responseType:"arraybuffer"}:void 0).then(function(e){if(n){var t=Buffer.from(e.data,"base64");return app.cache[o]={type:e.headers["content-type"],data:t},r.type(e.headers["content-type"]).send(t)}return app.cache[o]={data:e.data},r.send(e.data)}).catch(function(e){r.send(e.message),app.log.error(e)})});var _loop=function(r){app.get(r,function(e,t){t.render(routes[r],e.headers["x-barba"])})};for(var i in routes)_loop(i);app.setNotFoundHandler(function(e,t){t.code(404).type("text/plain").send("A custom not found")}),app.listen(PORT,function(e){e&&app.log.error(e),app.log.info("Server listening on port",PORT)});