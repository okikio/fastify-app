"use strict";"dev"in process.env&&require("dotenv").config();var _require=require("gulp"),src=_require.src,task=_require.task,series=_require.series,parallel=_require.parallel,dest=_require.dest,watch=_require.watch,_require2=require("gulp-sourcemaps"),init=_require2.init,write=_require2.write,webpackStream=require("webpack-stream"),autoprefix=require("gulp-autoprefixer"),replace=require("gulp-string-replace"),_require3=require("gulp-beautify"),html=_require3.html,js=_require3.js,_require4=require("child_process"),spawn=_require4.spawn,htmlmin=require("gulp-htmlmin"),assets=require("cloudinary").v2,uglify=require("gulp-uglify"),rename=require("gulp-rename"),_require5=require("through2"),obj=_require5.obj,babel=require("gulp-babel"),_require6=require("fs"),writeFile=_require6.writeFile,config=require("./config"),webpack=require("webpack"),sass=require("gulp-sass"),pug=require("gulp-pug"),pages=config.pages,cloud_name=config.cloud_name,dev="true"==process.env.dev;assets.config({cloud_name:cloud_name,secure:!0});var assetURL="https://res.cloudinary.com/".concat(cloud_name,"/"),assetURLConfig={quality:30,transformation:[{aspect_ratio:"4:3",crop:"fill"},{width:"auto",dpr:"auto",crop:"scale"}]},htmlMinOpts={minifyJS:!0,minifyCSS:!0,removeComments:!0,collapseWhitespace:!0,removeEmptyAttributes:!1,removeRedundantAttributes:!1,processScripts:["application/ld+json"]},minSuffix={suffix:".min"},watchDelay={delay:500},publicDest="public",webpackConfig={mode:dev?"development":"production",devtool:dev?"inline-cheap-source-map":"source-map",output:{filename:"app.min.js"}},stream=function(e){var r=1<arguments.length&&void 0!==arguments[1]?arguments[1]:{pipes:[],dest:publicDest},s=2<arguments.length?arguments[2]:void 0,t=src(e,r.opts),i=r.pipes||[],n=r.dest||publicDest;return i.forEach(function(e){t=t.pipe(e)}),t=t.pipe(dest(n)),s&&s(),t},stringify=function(e){var s=[];return JSON.stringify(e,function(e,r){return"function"==typeof r?(s.push(r.toString()),"_"):r},4).replace(/\"_\"/g,function(){return s.shift()})},exec=function(s,t){var e=s.split(/\s+/g);return spawn(e[0],e.slice(1),{stdio:"inherit"}).on("data",function(e){return process.stdout.write(e)}).on("exit",function(e){var r=null;e&&((r=new Error('Command "'+s+'" exited with wrong status code "'+e+'"')).code=e,r.cmd=s),t&&t(r)})},execSeries=function(s,t){var e=[];return function r(){e.push(exec(s.shift(),function(e){e?t(e):s.length?r():t(null)}))}(),e};task("html",function(e){for(var r in pages)stream("views/app.pug",{pipes:[rename({basename:r,extname:".html"}),pug({locals:pages[r]}),dev?html({indent_size:4}):htmlmin(htmlMinOpts),replace(/\/assets\/[^\s\"\']+/g,function(e){return(/\/raw\/[^\s\"\']+/.test(e)?"".concat(assetURL+e):assets.url(e,assetURLConfig)).replace("/assets/","")})]});e()}),task("css",function(){return stream("src/scss/app.scss",{pipes:[init(),sass({outputStyle:dev?"expanded":"compressed"}).on("error",sass.logError),autoprefix(),rename(minSuffix),write(".")],dest:"".concat(publicDest,"/css")})}),task("js",function(){return stream("src/js/app.js",{opts:{allowEmpty:!0},pipes:[webpackStream(webpackConfig,webpack),obj(function(e,r,s){/\.map$/.test(e.path)||this.push(e),s()}),init({loadMaps:!0}),babel(),dev?js({indent_size:4}):uglify(),write(".")],dest:"".concat(publicDest,"/js")})}),task("server",function(){return stream(["*.js","!*.min.js","!gulpfile.js","!config.js","!config-dev.js"],{opts:{allowEmpty:!0},pipes:[babel(),uglify(),rename(minSuffix)],dest:"."})}),task("config",function(){return writeFile("./config.min.js","module.exports = ".concat(stringify(config),";"),function(e){if(e)throw e}),stream("config.min.js",{opts:{allowEmpty:!0},pipes:[babel(),uglify()],dest:"."}),stream("config.min.js",{opts:{allowEmpty:!0},pipes:[js({indent_size:4}),rename({basename:"config-dev",extname:".js"})],dest:"."})}),task("config:watch",function(e){exec("gulp config server html --gulpfile ./gulpfile.min.js",function(){return e()})}),task("update",function(){return stream("gulpfile.js",{opts:{allowEmpty:!0},pipes:[babel(),uglify(),rename(minSuffix)],dest:"."})}),task("gulpfile:watch",function(e){exec("gulp update",function(){return e()})}),task("git",function(e){execSeries(["git add .","git commit -m 'Upgrade'","git push -u origin master"],function(){return e()})}),task("default",parallel(series("update","config","server","html"),"js","css")),task("watch",function(){watch(["config.js","containers/*.js"],watchDelay,series("config:watch")),watch("gulpfile.js",watchDelay,series("gulpfile:watch","server")),watch(["server.js","plugin.js"],watchDelay,series("server")),watch("views/**/*.pug",watchDelay,series("html","server")),watch("src/**/*.scss",watchDelay,series("css","server")),watch("src/**/*.js",watchDelay,series("js","server"))});